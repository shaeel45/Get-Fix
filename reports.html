<!DOCTYPE html>
<html lang="en" data-sidenav-size="condensed">
  <head>
    <meta charset="utf-8" />
    <title>
      Layout Icon View | Jidox - Material Design Admin & Dashboard Template
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      content="A fully featured admin theme which can be used to build CRM, CMS, etc."
      name="description"
    />
    <meta content="Coderthemes" name="author" />

    <!-- App favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

    <!-- Daterangepicker css -->
    <link
      rel="stylesheet"
      href="assets/vendor/daterangepicker/daterangepicker.css"
    />

    <!-- Vector Map css -->
    <link
      rel="stylesheet"
      href="assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css"
    />

    <!-- Theme Config Js -->
    <script src="assets/js/config.js"></script>

    <!-- App css -->
    <link
      href="assets/css/app.min.css"
      rel="stylesheet"
      type="text/css"
      id="app-style"
    />

    <!-- Icons css -->
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <style>
    .metric-card {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      height: 100%;
    }
    .metric-chart {
      width: 100%;
      height: 180px;
      margin-bottom: 10px;
    }
    .metric-value {
      font-weight: bold;
      font-size: 20px;
    }
    .metric-label {
      color: #6c757d;
    }
  </style>

  <body>
    <!-- Begin page -->
    <div class="wrapper">
      <!-- ========== Topbar Start ========== -->
            <div class="navbar-custom" style="background-color: #173d1f;">
                <div class="topbar container-fluid">
                    <div class="d-flex align-items-center gap-lg-2 gap-1">

                        <!-- Topbar Brand Logo -->
                        <div class="logo-topbar">
                            <!-- Logo light -->
                            <a href="index.html" class="logo-light">
                                <span class="">
                                    <img src="assets/images/logo.png"  style="height: 71px;" alt="logo">
                                </span>
                                <span class="">
                                    <img src="assets/images/logo-sm.png"  style="height: 71px;" alt="small logo">
                                </span>
                            </a>

                            <!-- Logo Dark -->
                            <a href="index.html" class="logo-dark">
                                <span class="">
                                    <img src="assets/images/logo-dark.png"  height="71" alt="dark logo">
                                </span>
                                <span class="">
                                    <img src="assets/images/logo-sm.png"  style="height: 71px;"  alt="small logo">
                                </span>
                            </a>
                        </div>

                        <!-- Sidebar Menu Toggle Button -->
                        <button class="button-toggle-menu">
                            <i class="ri-menu-2-fill"  style="color: white;"></i>
                        </button>

                        <!-- Horizontal Menu Toggle Button -->
                        <button class="navbar-toggle" data-bs-toggle="collapse" data-bs-target="#topnav-menu-content">
                            <div class="lines">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </button>

                       
                    </div>

                    <ul class="topbar-menu d-flex align-items-center gap-3">
                        


                        <li class="dropdown notification-list">
                            <a class="nav-link dropdown-toggle arrow-none" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                                <i class="ri-notification-3-fill fs-22"></i>
                                <span class="noti-icon-badge"></span>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animated dropdown-lg py-0">
                                <div class="p-2 border-top-0 border-start-0 border-end-0 border-dashed border">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h6 class="m-0 fs-16 fw-medium"> Notification</h6>
                                        </div>
                                        <div class="col-auto">
                                            <a href="javascript: void(0);" class="text-dark text-decoration-underline">
                                                <small>Clear All</small>
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div style="max-height: 300px;" data-simplebar>

                                    <h5 class="text-muted fs-12 fw-bold p-2 text-uppercase mb-0">Today</h5>
                                    <!-- item-->

                                    <a href="javascript:void(0);" class="dropdown-item p-0 notify-item unread-noti card m-0 shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="notify-icon bg-primary">
                                                        <i class="ri-message-3-line fs-18"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 text-truncate ms-2">
                                                    <h5 class="noti-item-title fw-medium fs-14">Datacorp <small class="fw-normal text-muted float-end ms-1">1 min ago</small></h5>
                                                    <small class="noti-item-subtitle text-muted">Caleb Flakelar commented on Admin</small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>

                                    <!-- item-->
                                    <a href="javascript:void(0);" class="dropdown-item p-0 notify-item read-noti card m-0 shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="notify-icon bg-info">
                                                        <i class="ri-user-add-line fs-18"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 text-truncate ms-2">
                                                    <h5 class="noti-item-title fw-medium fs-14">Admin <small class="fw-normal text-muted float-end ms-1">1 hr ago</small></h5>
                                                    <small class="noti-item-subtitle text-muted">New user registered</small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>

                                    <h5 class="text-muted fs-12 fw-bold p-2 mb-0 text-uppercase">Yesterday</h5>

                                    <!-- item-->
                                    <a href="javascript:void(0);" class="dropdown-item p-0 notify-item read-noti card m-0 shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="notify-icon">
                                                        <img src="assets/images/users/avatar-2.jpg" class="img-fluid rounded-circle" alt="" />
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 text-truncate ms-2">
                                                    <h5 class="noti-item-title fw-medium fs-14">Cristina Pride <small class="fw-normal text-muted float-end ms-1">1 day ago</small></h5>
                                                    <small class="noti-item-subtitle text-muted">Hi, How are you? What about our next meeting</small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>

                                    <h5 class="text-muted fs-12 fw-bold p-2 mb-0 text-uppercase">31 Jan 2023</h5>

                                    <!-- item-->
                                    <a href="javascript:void(0);" class="dropdown-item p-0 notify-item read-noti card m-0 shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="notify-icon bg-primary">
                                                        <i class="ri-discuss-line fs-18"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 text-truncate ms-2">
                                                    <h5 class="noti-item-title fw-medium fs-14">Datacorp</h5>
                                                    <small class="noti-item-subtitle text-muted">Caleb Flakelar commented on Admin</small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>

                                    <!-- item-->
                                    <a href="javascript:void(0);" class="dropdown-item p-0 notify-item read-noti card m-0 shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="notify-icon">
                                                        <img src="assets/images/users/avatar-4.jpg" class="img-fluid rounded-circle" alt="" />
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 text-truncate ms-2">
                                                    <h5 class="noti-item-title fw-medium fs-14">Karen Robinson</h5>
                                                    <small class="noti-item-subtitle text-muted">Wow ! this admin looks good and awesome design</small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </div>

                                <!-- All-->
                                <a href="javascript:void(0);" class="dropdown-item text-center text-primary text-decoration-underline fw-bold notify-item border-top border-light py-2">
                                    View All
                                </a>

                            </div>
                        </li>

                    </ul>
                </div>
            </div>
            <!-- ========== Topbar End ========== -->

            <!-- ========== Left Sidebar Start ========== -->
            <div class="leftside-menu" style="background-color: #173d1f;">

                <!-- Brand Logo Light -->
                <a href="index.html" class="logo logo-light">
                    <span class="logo-lg">
                        <img src="assets/images/logo.png" style="height: 71px;"  alt="logo">
                    </span>
                    <span class="logo-sm">
                        <img src="assets/images/logo-sm.png" style="height: 71px; margin-left: -15px;"  alt="small logo">
                    </span>
                </a>

                <!-- Brand Logo Dark -->
                <a href="index.html" class="logo logo-dark">
                    <span class="logo-lg">
                        <img src="assets/images/logo-dark.png"  style="height: 71px;"   alt="dark logo">
                    </span>
                    <span class="logo-sm">
                        <img src="assets/images/logo-sm.png" style="height: 71px; margin-left: -15px;"  alt="small logo">
                    </span>
                </a>

                <!-- Sidebar Hover Menu Toggle Button -->
                <div class="button-sm-hover" data-bs-toggle="tooltip" data-bs-placement="right" title="Show Full Sidebar">
                    <i class="ri-checkbox-blank-circle-line align-middle"></i>
                </div>

                <!-- Full Sidebar Menu Close Button -->
                <div class="button-close-fullsidebar">
                    <i class="ri-close-fill align-middle"></i>
                </div>

                <!-- Sidebar -left -->
                <div class="h-100" id="leftside-menu-container" data-simplebar>
                    <!-- Leftbar User -->
                    <!-- <div class="leftbar-user p-3 text-white">
                        <a href="" class="d-flex align-items-center text-reset">
                            <div class="flex-shrink-0">
                                <img src="assets/images/users/avatar-1.jpg" alt="user-image" height="42" class="rounded-circle shadow">
                            </div>
                            <div class="flex-grow-1 ms-2">
                                <span class="fw-semibold fs-15 d-block">Doris Larson</span>
                                <span class="fs-13">Founder</span>
                            </div>
                            <div class="ms-auto">
                                <i class="ri-arrow-right-s-fill fs-20"></i>
                            </div>
                        </a>
                    </div> -->

                    <!--- Sidemenu -->
                    <ul class="side-nav">

                        <li class="side-nav-title mt-1" style="color: white;"> Main</li>

                        <li class="side-nav-item">
                            <a href="index.html" class="side-nav-link">
                                <i class="ri-dashboard-2-fill"></i>
                                <span class="badge bg-success float-end">9+</span>
                                <span> Dashboard </span>
                            </a>
                        </li>

                         <li class="side-nav-item">
                            <a href="apps-file-manager.html" class="side-nav-link">
                                <i class="fas fa-users"></i>
                                <span> Leads & Estimate Management </span>
                            </a>
                        </li>

                        <li class="side-nav-item">
                            <a href="job-assignment.html" class="side-nav-link">
                                <i class="fas fa-briefcase"></i>
                                <span> Job Assignment </span>
                            </a>
                        </li>

                         <li class="side-nav-item">
                            <a href="customer-managment.html" class="side-nav-link">
                                <i class="fas fa-user-friends"></i>
                                <span> Customer Management </span>
                            </a>
                        </li>

                         <li class="side-nav-item">
                            <a href="vendor-directory.html" class="side-nav-link">
                                <i class="fas fa-address-book"></i>
                                <span> Vendor Directory </span>
                            </a>
                        </li>

                         <li class="side-nav-item">
                            <a href="job-tracking.html" class="side-nav-link">
                                <i class="fas fa-tasks"></i>
                                <span> Job Tracking </span>
                            </a>
                        </li>

                         <li class="side-nav-item">
                            <a href="reports.html" class="side-nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span> Reports & Analytics </span>
                            </a>
                        </li>

                        <li class="side-nav-item">
                            <a href="payment-handling.html" class="side-nav-link">
                                <i class="fas fa-money-bill-wave"></i>
                                <span> Payment Handling </span>
                            </a>
                        </li>


                        <li class="side-nav-item">
                        <a href="service.html" class="side-nav-link">
                                 <i class="fas fa-cog"></i>
                                <span> Service & Category Management </span>
                            </a>
                        </li>

                        <li class="side-nav-item">
                            <a href="apps-chat.html" class="side-nav-link">
                                <i class="ri-chat-voice-fill"></i>
                                <span> Chat </span>
                            </a>
                        </li>

                        <li class="side-nav-item">
                            <a href="user.html" class="side-nav-link">
                                <i class="fas fa-user"></i>
                                <span> User </span>
                            </a>
                        </li>
                    </ul>
                    <!--- End Sidemenu -->

                    <div class="clearfix"></div>
                </div>
            </div>

      <!-- ============================================================== -->
      <!-- Start Page Content here -->
      <!-- ============================================================== -->

      <div class="content-page">
        <div class="content">
          <!-- Start Content-->
          <div class="container-fluid mt-4">
            <div class="card">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">Reports & Analytics</h5>
                <div>
                  <button
                    class="btn btn-sm btn-outline-danger me-2"
                    id="downloadPDF"
                  >
                    <i class="fas fa-file-pdf"></i> PDF
                  </button>
                  <button
                    class="btn btn-sm btn-outline-success"
                    id="downloadCSV"
                  >
                    <i class="fas fa-file-csv"></i> CSV
                  </button>
                </div>
              </div>
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-chart">
                      <canvas id="leadsMetricChart"></canvas>
                    </div>
                    <div class="metric-value">156</div>
                    <div class="metric-label">Number of Leads</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-chart">
                      <canvas id="conversionMetricChart"></canvas>
                    </div>
                    <div class="metric-value">23%</div>
                    <div class="metric-label">Conversion Rate</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-chart">
                      <canvas id="revenueMetricChart"></canvas>
                    </div>
                    <div class="metric-value">$28,900</div>
                    <div class="metric-label">Revenue</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-chart">
                      <canvas id="avgJobMetricChart"></canvas>
                    </div>
                    <div class="metric-value">$318</div>
                    <div class="metric-label">Avg. Job Value</div>
                  </div>
                </div>
              </div>

              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover" id="metricsTable">
                    <thead class="table-">
                      <tr>
                        <th
                          style="color: #173d1f"
                          data-time="Metric"
                          data-metric="Metric"
                        >
                          Metric
                        </th>
                        <th
                          style="color: #173d1f"
                          data-time="ThisWeek"
                          data-metric="leads"
                        >
                          This Week
                        </th>
                        <th
                          style="color: #173d1f"
                          data-time="LastWeek"
                          data-metric="leads"
                        >
                          Last Week
                        </th>
                        <th
                          style="color: #173d1f"
                          data-time="Change"
                          data-metric="leads"
                        >
                          Change
                        </th>
                        <th
                          style="color: #173d1f"
                          data-time="MTD"
                          data-metric="leads"
                        >
                          MTD
                        </th>
                        <th
                          style="color: #173d1f"
                          data-time="YTD"
                          data-metric="leads"
                        >
                          YTD
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Number of Leads</td>
                        <td data-metric="leads" data-time="thisWeek">42</td>
                        <td data-metric="leads" data-time="lastWeek">38</td>
                        <td class="text-success">+10.5%</td>
                        <td data-metric="leads" data-time="MTD">156</td>
                        <td data-metric="leads" data-time="YTD">1240</td>
                      </tr>
                      <tr>
                        <td>Conversion Rate (%)</td>
                        <td data-metric="conversion" data-time="thisWeek">
                          24
                        </td>
                        <td data-metric="conversion" data-time="lastWeek">
                          22
                        </td>
                        <td class="text-success">+2.0%</td>
                        <td data-metric="conversion" data-time="MTD">23</td>
                        <td data-metric="conversion" data-time="YTD">21</td>
                      </tr>
                      <tr>
                        <td>Revenue ($)</td>
                        <td data-metric="revenue" data-time="thisWeek">8450</td>
                        <td data-metric="revenue" data-time="lastWeek">7200</td>
                        <td class="text-success">+17.4%</td>
                        <td data-metric="revenue" data-time="MTD">28900</td>
                        <td data-metric="revenue" data-time="YTD">245800</td>
                      </tr>
                      <tr>
                        <td>Avg. Job Value ($)</td>
                        <td data-metric="avgJob" data-time="thisWeek">325</td>
                        <td data-metric="avgJob" data-time="lastWeek">315</td>
                        <td class="text-success">+3.2%</td>
                        <td data-metric="avgJob" data-time="MTD">318</td>
                        <td data-metric="avgJob" data-time="YTD">305</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <div class="chart-container">
                        <canvas id="leadsChart"></canvas>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- container -->
        </div>
        <!-- content -->

        <!-- Footer Start -->
      </div>

      <!-- ============================================================== -->
      <!-- End Page content -->
      <!-- ============================================================== -->
    </div>
    <!-- END wrapper -->

    <!-- Vendor js -->
    <script src="assets/js/vendor.min.js"></script>

    <!-- Daterangepicker js -->
    <script src="assets/vendor/daterangepicker/moment.min.js"></script>
    <script src="assets/vendor/daterangepicker/daterangepicker.js"></script>

    <!-- Apex Charts js -->
    <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>

    <!-- Vector Map js -->
    <script src="assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="assets/vendor/admin-resources/jquery.vectormap/maps/jquery-jvectormap-world-mill-en.js"></script>

    <!-- Dashboard App js -->
    <script src="assets/js/pages/demo.dashboard.js"></script>

    <!-- App js -->
    <script src="assets/js/app.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      function getMetricData(metricKey) {
        const times = ["thisWeek", "lastWeek", "MTD", "YTD"];
        return times.map((time) => {
          const cell = document.querySelector(
            `td[data-metric="${metricKey}"][data-time="${time}"]`
          );
          return cell ? parseFloat(cell.innerText.replace(/[^0-9\.]/g, "")) : 0;
        });
      }

      window.addEventListener("DOMContentLoaded", function () {
        // Chart: Leads
        const leadsCtx = document.getElementById("leadsChart").getContext("2d");
        const leadsData = getMetricData("leads");
        const leadsChart = new Chart(leadsCtx, {
          type: "line",
          data: {
            labels: ["This Week", "Last Week", "MTD", "YTD"],
            datasets: [
              {
                label: "Number of Leads",
                data: leadsData,
                borderColor: "rgb(75, 192, 192)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                tension: 0.4,
                fill: true,
                pointRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
            },
            scales: {
              y: { beginAtZero: true },
            },
          },
        });

        // Chart: Revenue
        const revenueCtx = document
          .getElementById("revenueChart")
          .getContext("2d");
        const revenueData = getMetricData("revenue");
        const revenueChart = new Chart(revenueCtx, {
          type: "bar",
          data: {
            labels: ["This Week", "Last Week", "MTD", "YTD"],
            datasets: [
              {
                label: "Revenue ($)",
                data: revenueData,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                ],
                borderColor: [
                  "rgba(54, 162, 235, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(54, 162, 235, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
            },
            scales: {
              y: { beginAtZero: true },
            },
          },
        });

        // CSV download for table
        document
          .getElementById("downloadCSV")
          .addEventListener("click", function () {
            let csv = [];
            const rows = document.querySelectorAll("#metricsTable tr");
            rows.forEach((row) => {
              const cols = row.querySelectorAll("th, td");
              const rowData = [];
              cols.forEach((col) => {
                rowData.push(col.innerText.trim());
              });
              csv.push(rowData.join(","));
            });
            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "metrics_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });

        // PDF download of the card content
        document
          .getElementById("downloadPDF")
          .addEventListener("click", async function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");

            const card = document.querySelector(".card");
            const canvas = await html2canvas(card, { scale: 2 });
            const imgData = canvas.toDataURL("image/png");

            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
            doc.save("report_metrics.pdf");
          });
      });
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }

      window.addEventListener("load", function () {
        window.scrollTo(0, 0);
      });

      // Fetch metric data for the selected timeframe
      function getMetricDataFromTable(timeframe = "MTD") {
        const metricElements = document.querySelectorAll(
          `[data-time="${timeframe}"]`
        );
        const metrics = {};
        metricElements.forEach((cell) => {
          const metricKey = cell.getAttribute("data-metric");
          let value = parseFloat(cell.innerText.replace(/[$,%]/g, "")) || 0;
          metrics[metricKey] = { value: value };
        });

        // Define max values (these could be dynamically calculated or fetched)
        metrics.leads.max = 200;
        metrics.conversion.max = 100;
        metrics.revenue.max = 50000;
        metrics.avgJob.max = 500;

        return metrics;
      }

      let charts = {}; // Store chart instances

      function createMetricChart(canvasId, metricKey, color, metrics) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        const metricData = metrics[metricKey];

        // Destroy previous chart if it exists
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        charts[canvasId] = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [metricKey, "Remaining"],
            datasets: [
              {
                data: [metricData.value, metricData.max - metricData.value],
                backgroundColor: [color, "#e9ecef"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function (context) {
                    return `${context.label}: ${context.parsed}`;
                  },
                },
              },
            },
          },
        });
      }

      function renderChartsForTimeframe(timeframe) {
        const metrics = getMetricDataFromTable(timeframe);

        createMetricChart("leadsMetricChart", "leads", "#20c997", metrics);
        createMetricChart(
          "conversionMetricChart",
          "conversion",
          "#0d6efd",
          metrics
        );
        createMetricChart("revenueMetricChart", "revenue", "#ffc107", metrics);
        createMetricChart("avgJobMetricChart", "avgJob", "#dc3545", metrics);
      }

      window.addEventListener("DOMContentLoaded", function () {
        // Initial render for default 'MTD'
        renderChartsForTimeframe("MTD");

        // Timeframe buttons
        const timeButtons = document.querySelectorAll("[data-time-btn]");
        timeButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const selectedTime = this.getAttribute("data-time-btn");
            renderChartsForTimeframe(selectedTime);
          });
        });

        // CSV Download
        document
          .getElementById("downloadCSV")
          .addEventListener("click", function (e) {
            e.preventDefault();
            let csv = [];
            const rows = document.querySelectorAll("#metricsTable tr");
            rows.forEach((row) => {
              const cols = row.querySelectorAll("th, td");
              const rowData = [];
              cols.forEach((col) => {
                rowData.push(col.innerText.trim());
              });
              csv.push(rowData.join(","));
            });
            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "metrics_report.csv");
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });

        // PDF Download
        document
          .getElementById("downloadPDF")
          .addEventListener("click", async function (e) {
            e.preventDefault();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");
            const card = document.querySelector(".card");
            const canvas = await html2canvas(card, { scale: 2 });
            const imgData = canvas.toDataURL("image/png");
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
            doc.save("report_metrics.pdf");
          });
      });
    </script>
  </body>
</html>
